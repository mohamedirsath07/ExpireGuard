<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ExpireGuard App</title>
    
    <!-- SYSTEM IMPORTS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- UI CONFIGURATION -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151b23', 900: '#0f172a', 950: '#020617' },
                        emerald: { 450: '#10b981', 550: '#059669' }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            background-color: #020617; 
            color: #e2e8f0; 
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .scanner-line { box-shadow: 0 0 20px rgba(16, 185, 129, 0.9); }
        
        /* Mobile Safe Areas */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Hide Scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // ==========================================
    // 1. DATABASE LAYER
    // ==========================================
    class LocalStorageDB {
        constructor(collectionName) {
            this.collection = collectionName;
        }

        getAll() {
            try {
                const data = localStorage.getItem(this.collection);
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        }

        add(item) {
            const current = this.getAll();
            const newItem = { id: Date.now().toString(), createdAt: new Date().toISOString(), ...item };
            const updated = [newItem, ...current];
            localStorage.setItem(this.collection, JSON.stringify(updated));
            return newItem;
        }

        remove(id) {
            const current = this.getAll();
            const updated = current.filter(item => item.id !== id);
            localStorage.setItem(this.collection, JSON.stringify(updated));
            return true;
        }
    }

    const db = new LocalStorageDB('expireguard_v2_categories');

    // ==========================================
    // 2. BACKEND LAYER & OCR SIMULATION
    // ==========================================
    const API = {
        fetchProducts: async () => {
            return new Promise(resolve => setTimeout(() => resolve(db.getAll()), 100));
        },
        addProduct: async (product) => {
            return new Promise(resolve => setTimeout(() => resolve(db.add(product)), 300));
        },
        deleteProduct: async (id) => {
            return new Promise(resolve => setTimeout(() => resolve(db.remove(id)), 100));
        },
        // OCR LOGIC: Specifically targets Date Extraction
        processImage: async () => {
            return new Promise(resolve => {
                setTimeout(() => {
                    // In a real Tesseract.js implementation, we would use regex:
                    // const dateRegex = /(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})|(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/;
                    
                    // Simulation: Determine a random future date
                    const future = new Date();
                    future.setDate(future.getDate() + Math.floor(Math.random() * 60) + 1); // 1-60 days out
                    
                    resolve({ 
                        success: true, 
                        // Return YYYY-MM-DD format
                        date: future.toISOString().split('T')[0]
                    });
                }, 2000);
            });
        }
    };

    // ==========================================
    // 3. FRONTEND LAYER
    // ==========================================

    // --- ICONS ---
    const Icon = ({ name, size = 24, className }) => {
        const paths = {
            scan: <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>,
            camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
            trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>,
            plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
            x: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
            alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            // Categories
            groceries: <path d="M18 6 6 18M6 6 18 18 M12 2l3 6M9 8l3-6"/>, // Placeholder abstract
            food: <><path d="M18 8c0 4.5-3.5 8-8 8s-8-3.5-8-8 3.5-8 8-8 8 3.5 8 8z"/><path d="M12 2v6"/></>, // Apple-ish
            medicine: <><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></>,
            cosmetics: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>, // Shield/Beauty
            all: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        };
        
        // Better Category Icons Mappings
        if(name === 'Groceries') return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        if(name === 'Food') return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 8c0 4.5-3.5 8-8 8s-8-3.5-8-8 3.5-8 8-8 8 3.5 8 8z"/><path d="M12 2v6"/></svg>;
        if(name === 'Medicine') return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 3v13h-4V3h4zM9 3v13H5V3h4zM9 16h6v5H9v-5z"/></svg>;
        if(name === 'Cosmetics') return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2l9 4.9V17L12 22l-9-4.9V7z"/></svg>; // Hexagon/Compact
        
        return (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {paths[name] || paths['alert']}
            </svg>
        );
    };

    // --- CONFIG ---
    const CATEGORIES = ['All', 'Groceries', 'Food', 'Medicine', 'Cosmetics'];

    // --- UTILS ---
    const getStatus = (dateStr) => {
        if (!dateStr) return { color: "bg-slate-700", label: "Unknown", days: "--" };
        const today = new Date();
        today.setHours(0,0,0,0);
        const expiry = new Date(dateStr);
        const diffTime = expiry - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        if (diffDays < 0) return { color: "bg-red-500", text: "text-red-500", label: "Expired", days: `${Math.abs(diffDays)}d ago` };
        if (diffDays <= 3) return { color: "bg-red-500", text: "text-red-500", label: "Critical", days: `${diffDays}d left` };
        if (diffDays <= 7) return { color: "bg-orange-500", text: "text-orange-500", label: "Expiring", days: `${diffDays}d left` };
        return { color: "bg-emerald-500", text: "text-emerald-500", label: "Good", days: `${diffDays}d left` };
    };

    // --- SCREEN: SCANNER ---
    const Scanner = ({ onClose, onScanComplete }) => {
        const [processing, setProcessing] = useState(false);
        const videoRef = useRef(null);
        const lineRef = useRef(null);

        useEffect(() => {
            let stream = null;
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(s => {
                        stream = s;
                        if (videoRef.current) videoRef.current.srcObject = s;
                    })
                    .catch(e => console.log("Camera failed", e));
            }

            gsap.to(lineRef.current, { top: "100%", duration: 2, repeat: -1, yoyo: true, ease: "power1.inOut" });

            return () => {
                if (stream) stream.getTracks().forEach(track => track.stop());
            };
        }, []);

        const capture = async () => {
            setProcessing(true);
            const result = await API.processImage();
            setProcessing(false);
            onScanComplete(result.date);
        };

        return (
            <div className="fixed inset-0 z-50 bg-black flex flex-col items-center animate-[fadeIn_0.3s_ease-out]">
                {/* Header */}
                <div className="absolute top-0 w-full p-4 safe-top flex justify-between items-center z-20 bg-gradient-to-b from-black/80 to-transparent">
                    <span className="text-white font-bold tracking-wider flex items-center gap-2 text-sm">
                        <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> DATE SCANNER
                    </span>
                    <button onClick={onClose} className="p-2 bg-white/10 rounded-full backdrop-blur-md active:bg-white/20"><Icon name="x" /></button>
                </div>

                {/* Viewport */}
                <div className="relative w-full h-full bg-slate-900 overflow-hidden">
                    <video ref={videoRef} autoPlay playsInline muted className="absolute inset-0 w-full h-full object-cover opacity-80"></video>
                    
                    {/* HUD */}
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div className="w-[85%] aspect-[3/2] border-2 border-white/30 rounded-xl relative overflow-hidden shadow-[0_0_0_100vh_rgba(0,0,0,0.5)]">
                            {/* Text hint */}
                            <div className="absolute -top-8 left-0 w-full text-center text-white/80 text-xs font-bold tracking-widest uppercase">Align Date Here</div>
                            {/* Laser */}
                            <div ref={lineRef} className="absolute top-0 left-0 w-full h-0.5 bg-emerald-400 scanner-line"></div>
                        </div>
                    </div>

                    {/* Loading Overlay */}
                    {processing && (
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center z-30">
                            <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <div className="text-emerald-400 font-mono text-sm tracking-widest animate-pulse">EXTRACTING DATE...</div>
                        </div>
                    )}
                </div>

                {/* Controls */}
                <div className="absolute bottom-0 w-full p-8 safe-bottom flex justify-center z-30 bg-gradient-to-t from-black/80 to-transparent">
                    <button onClick={capture} disabled={processing} className="w-20 h-20 rounded-full border-4 border-white/20 bg-emerald-600 flex items-center justify-center text-white shadow-[0_0_30px_rgba(16,185,129,0.4)] active:scale-95 transition-all disabled:opacity-50 disabled:scale-100">
                        <Icon name="camera" size={32} />
                    </button>
                </div>
            </div>
        );
    };

    // --- SCREEN: DASHBOARD ---
    const Dashboard = ({ products, onDelete }) => {
        const [activeCat, setActiveCat] = useState('All');
        const listRef = useRef(null);

        // Filter then Sort
        const filteredProducts = useMemo(() => {
            const filtered = activeCat === 'All' ? products : products.filter(p => p.category === activeCat);
            return filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
        }, [products, activeCat]);
        
        const stats = {
            total: filteredProducts.length,
            expiring: filteredProducts.filter(p => { const s = getStatus(p.expiryDate); return s.label === "Expiring" || s.label === "Critical" }).length,
        };

        useEffect(() => {
            if(listRef.current) {
                // Reset animation when category changes
                gsap.fromTo(listRef.current.children, { opacity: 0, y: 15 }, { opacity: 1, y: 0, stagger: 0.05, duration: 0.4, ease: "power2.out" });
            }
        }, [activeCat, products.length]);

        return (
            <div className="pb-32 pt-24 px-4 max-w-xl mx-auto safe-top">
                {/* Category Filter Tabs */}
                <div className="flex gap-3 overflow-x-auto pb-4 no-scrollbar mb-2">
                    {CATEGORIES.map(cat => (
                        <button 
                            key={cat} 
                            onClick={() => setActiveCat(cat)}
                            className={`whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold border transition-all ${
                                activeCat === cat 
                                ? 'bg-emerald-600 border-emerald-500 text-white shadow-lg shadow-emerald-500/20' 
                                : 'bg-slate-900 border-slate-700 text-slate-400'
                            }`}
                        >
                            {cat}
                        </button>
                    ))}
                </div>

                {/* Statistics (Contextual) */}
                <div className="grid grid-cols-2 gap-3 mb-6">
                    <div className="glass p-3 rounded-2xl flex items-center gap-3">
                        <div className="bg-slate-800 p-2 rounded-lg text-white"><Icon name="plus" size={16} /></div>
                        <div>
                            <span className="text-xl font-bold text-white block leading-none">{stats.total}</span>
                            <span className="text-[10px] text-slate-400 uppercase font-bold">{activeCat} Items</span>
                        </div>
                    </div>
                    <div className="glass p-3 rounded-2xl flex items-center gap-3 bg-orange-500/5 border-orange-500/20">
                        <div className="bg-orange-500/20 p-2 rounded-lg text-orange-400"><Icon name="alert" size={16} /></div>
                        <div>
                            <span className="text-xl font-bold text-orange-400 block leading-none">{stats.expiring}</span>
                            <span className="text-[10px] text-orange-400/60 uppercase font-bold">Expiring</span>
                        </div>
                    </div>
                </div>

                <div className="flex items-center justify-between mb-4 px-1">
                    <h3 className="text-lg font-bold text-white">{activeCat === 'All' ? 'Everything' : activeCat}</h3>
                </div>

                {/* Product List */}
                <div ref={listRef} className="space-y-3">
                    {filteredProducts.length === 0 && (
                        <div className="text-center py-24 opacity-40">
                            <Icon name="scan" className="mx-auto mb-4" size={40} />
                            <p>No items found.</p>
                            <p className="text-sm mt-2">Add some {activeCat.toLowerCase()}.</p>
                        </div>
                    )}

                    {filteredProducts.map(product => {
                        const status = getStatus(product.expiryDate);
                        return (
                            <div key={product.id} className="glass p-4 rounded-xl flex items-center justify-between relative overflow-hidden group touch-manipulation active:scale-[0.98] transition-transform">
                                <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${status.color}`}></div>
                                
                                <div className="ml-3 flex-1">
                                    <div className="flex justify-between items-start">
                                        <h4 className="font-bold text-slate-100 text-lg leading-tight truncate pr-2">{product.name}</h4>
                                        <span className="text-[10px] bg-slate-800 text-slate-400 px-1.5 py-0.5 rounded uppercase tracking-wider">{product.category}</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 flex items-center gap-2">
                                        {product.expiryDate}
                                    </div>
                                </div>

                                <div className="flex flex-col items-end gap-2 ml-4">
                                    <span className={`px-2 py-1 rounded-md text-[10px] font-bold border ${status.color.replace('bg-', 'border-')} ${status.text} bg-opacity-10 uppercase tracking-wide whitespace-nowrap`}>
                                        {status.days}
                                    </span>
                                    <button onClick={(e) => {e.stopPropagation(); onDelete(product.id)}} className="text-slate-600 active:text-red-400 p-2 -mr-2">
                                        <Icon name="trash" size={18} />
                                    </button>
                                </div>
                            </div>
                        )
                    })}
                </div>
            </div>
        );
    };

    // --- MAIN APP ---
    const App = () => {
        const [products, setProducts] = useState([]);
        const [loading, setLoading] = useState(true);
        const [view, setView] = useState('dashboard');
        
        // Add Item Form State
        const [newItem, setNewItem] = useState({ name: '', date: '', category: 'Groceries' });

        useEffect(() => {
            API.fetchProducts().then(data => { setProducts(data); setLoading(false); });
        }, []);

        const handleDelete = async (id) => {
            await API.deleteProduct(id);
            setProducts(prev => prev.filter(p => p.id !== id));
        };

        const handleSave = async () => {
            if(!newItem.name || !newItem.date) return;
            const savedItem = await API.addProduct({ 
                name: newItem.name, 
                expiryDate: newItem.date,
                category: newItem.category
            });
            setProducts(prev => [savedItem, ...prev]);
            setView('dashboard');
            setNewItem({ name: '', date: '', category: 'Groceries' });
        };

        if (loading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center"><div className="w-8 h-8 border-4 border-emerald-500 rounded-full animate-spin border-t-transparent"></div></div>;

        return (
            <div className="min-h-screen bg-slate-950 text-slate-200">
                {/* Navbar */}
                <nav className="fixed top-0 w-full bg-slate-950/80 backdrop-blur-xl border-b border-white/5 z-40 px-5 pt-safe-top pb-4 flex justify-between items-center safe-top shadow-lg">
                    <div className="flex items-center gap-2 mt-2">
                        <div className="bg-emerald-600 p-1.5 rounded-lg text-white shadow-lg shadow-emerald-500/20"><Icon name="scan" size={20} /></div>
                        <h1 className="font-bold text-xl tracking-tight text-white">Expire<span className="text-emerald-500">Guard</span></h1>
                    </div>
                </nav>

                {/* Views */}
                {view === 'dashboard' && <Dashboard products={products} onDelete={handleDelete} />}
                
                {view === 'scanner' && <Scanner onClose={() => setView('dashboard')} onScanComplete={(date) => { setNewItem(p => ({...p, date})); setView('add'); }} />}

                {/* Add Modal */}
                {view === 'add' && (
                    <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-4 animate-[fadeIn_0.2s_ease-out]">
                        <div className="bg-slate-900 w-full max-w-sm rounded-3xl p-6 border border-white/10 shadow-2xl relative mb-safe-bottom overflow-y-auto max-h-[90vh]">
                            <button onClick={() => setView('dashboard')} className="absolute top-5 right-5 text-slate-500 active:text-white"><Icon name="x" /></button>
                            <h3 className="text-xl font-bold text-white mb-6">Add Item</h3>
                            
                            <div className="space-y-5">
                                {/* Name Input */}
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Name</label>
                                    <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-white focus:border-emerald-500 outline-none transition-all placeholder:text-slate-700" placeholder="e.g. Milk" autoFocus />
                                </div>

                                {/* Category Selection */}
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Category</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {CATEGORIES.filter(c => c !== 'All').map(cat => (
                                            <button
                                                key={cat}
                                                onClick={() => setNewItem({...newItem, category: cat})}
                                                className={`p-3 rounded-xl border flex items-center gap-2 transition-all ${
                                                    newItem.category === cat 
                                                    ? 'bg-emerald-600/20 border-emerald-500 text-white' 
                                                    : 'bg-slate-950 border-slate-700 text-slate-500'
                                                }`}
                                            >
                                                <div className={newItem.category === cat ? 'text-emerald-400' : 'text-slate-600'}>
                                                    <Icon name={cat} size={18} />
                                                </div>
                                                <span className="text-sm font-bold">{cat}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Date Input & Scan */}
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Expiry Date</label>
                                    <div className="flex gap-3">
                                        <input type="date" value={newItem.date} onChange={e => setNewItem({...newItem, date: e.target.value})} className="flex-1 bg-slate-950 border border-slate-700 rounded-xl p-4 text-white focus:border-emerald-500 outline-none" />
                                        <button onClick={() => setView('scanner')} className="px-4 bg-slate-800 rounded-xl border border-slate-700 text-emerald-500 active:bg-slate-700 flex flex-col items-center justify-center gap-1">
                                            <Icon name="scan" size={20} />
                                            <span className="text-[8px] uppercase font-bold tracking-wider">Scan</span>
                                        </button>
                                    </div>
                                </div>

                                <button onClick={handleSave} className="w-full py-4 bg-emerald-600 rounded-xl text-white font-bold shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform mt-2">
                                    Save Product
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* FAB */}
                {view === 'dashboard' && (
                    <button onClick={() => setView('add')} className="fixed bottom-8 right-6 w-14 h-14 bg-emerald-600 rounded-full flex items-center justify-center text-white shadow-2xl shadow-emerald-500/40 active:scale-90 transition-transform z-30 mb-safe-bottom">
                        <Icon name="plus" size={28} />
                    </button>
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>